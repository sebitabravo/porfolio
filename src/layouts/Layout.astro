---
import Footer from "../components/Footer.astro";
import Header from "../components/Header.astro";
import SpeedInsights from "@vercel/speed-insights/astro";

export interface Props {
  title: string;
  description?: string;
}

const {
  title,
  description = "Porfolio de Sebastian Bravo - Desarrollador Full Stack",
} = Astro.props;

// Critical CSS content
const criticalCSS = `
/* Critical CSS for above-the-fold content */
html {
  font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  line-height: 1.6;
  scroll-behavior: smooth;
}

@media (prefers-reduced-motion: reduce) {
  html { scroll-behavior: auto; }
}

body {
  margin: 0;
  padding: 0;
  min-height: 100vh;
  background-color: #fafafa;
  color: #171717;
  transition: background-color 0.3s ease, color 0.3s ease;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  text-rendering: optimizeLegibility;
}

.dark body {
  background-color: #171717;
  color: #fafafa;
}

header {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  z-index: 50;
  background-color: rgba(250, 250, 250, 0.8);
  backdrop-filter: blur(8px);
  border-bottom: 1px solid rgba(229, 229, 229, 0.3);
  height: 64px;
}

.dark header {
  background-color: rgba(23, 23, 23, 0.8);
  border-bottom-color: rgba(64, 64, 64, 0.3);
}

main {
  padding-top: 96px;
  min-height: calc(100vh - 96px);
}

img {
  max-width: 100%;
  height: auto;
  display: block;
}

.preload-hidden { opacity: 0; }
.preload-visible { opacity: 1; transition: opacity 0.3s ease-in-out; }

.reduce-motion *,
.reduce-motion *::before,
.reduce-motion *::after {
  animation-duration: 0.01ms !important;
  animation-iteration-count: 1 !important;
  transition-duration: 0.01ms !important;
  scroll-behavior: auto !important;
}

* { box-sizing: border-box; }

[class*="animate-"],
[class*="transition-"],
.will-change-transform { will-change: transform; }

.will-change-opacity { will-change: opacity; }

@media (max-width: 640px) {
  main { padding-top: 80px; }
}
`;
---

<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="description" content={description} />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />

    <!-- Performance optimizations -->
    <meta name="format-detection" content="telephone=no" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    
    <!-- Critical CSS inlined -->
    <style set:html={criticalCSS}></style>

    <!-- Preconnect to critical domains -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link rel="preconnect" href="https://vercel.live" />
    <link rel="preconnect" href="https://vitals.vercel-insights.com" />

    <!-- DNS prefetch for performance -->
    <link rel="dns-prefetch" href="//static.cloudflareinsights.com" />
    
    <!-- Critical resource preloads -->
    <link rel="preload" href="/ProfileImage.webp" as="image" fetchpriority="high" />
    
    <!-- Favicon optimized -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="generator" content={Astro.generator} />
    <title>{title}</title>

    <!-- Custom head content -->
    <slot name="head" />

    <!-- Optimized theme script to prevent FOUC -->
    <script is:inline data-critical>
      (function () {
        const getThemePreference = () => {
          if (
            typeof localStorage !== "undefined" &&
            localStorage.getItem("theme")
          ) {
            return localStorage.getItem("theme");
          }
          return window.matchMedia("(prefers-color-scheme: dark)").matches
            ? "dark"
            : "light";
        };

        const isDark = getThemePreference() === "dark";
        document.documentElement.classList[isDark ? "add" : "remove"]("dark");

        if (typeof localStorage !== "undefined") {
          localStorage.setItem("theme", getThemePreference());
        }
      })();
    </script>
  </head>
  <body
    class="bg-neutral-50 dark:bg-neutral-900 text-neutral-900 dark:text-neutral-100 transition-all duration-300 antialiased"
  >
    <Header />
    <main class="pt-24">
      <slot />
    </main>
    <Footer />
    <SpeedInsights />

    <!-- Load global CSS asynchronously -->
    <link rel="stylesheet" href="/src/styles/global.css" media="print" onload="this.media='all'; this.onload=null;" />
    <noscript><link rel="stylesheet" href="/src/styles/global.css" /></noscript>

    <!-- Performance optimizations script -->
    <script type="module">
      import { initPerformanceOptimizations } from "/src/utils/performanceOptimizer.ts";
      
      // Initialize immediately for critical optimizations
      initPerformanceOptimizations();
      
      // Additional optimization for page load
      if ('requestIdleCallback' in window) {
        requestIdleCallback(() => {
          // Additional non-critical optimizations
          console.log('Performance optimizations loaded');
        });
      }
    </script>
  </body>
</html>
